#!/usr/bin/perl -I lib/

use strict;
use warnings;

use Getopt::Long::Descriptive qw(describe_options);
use Try::Tiny;

use DnsSync::Provider::Route53;
use DnsSync::Provider::ZoneFile;
use DnsSync::Utils qw(verbose set_verbosity);

use Data::Dumper;

my ($cli) = describe_options(
	'dns-sync %o',
	[ 'zone|z=s', 'Route 53 Zone ID', { required => 1 } ],
	[ 'directory|dir|d=s', 'Path to directory containing JSON files to sync', ],
	[ 'verbose|v', 'Increases logging verbosity', ],
	[ 'wait', 'Prevent exit until changes have propogated to DNS servers', ],
	[ 'origin=s', 'Use specified DNS zone origin for write operations. This allows a record set to be transposed from one origin to another when source and target origins differ. Note that some providers force the origin to a particular value based on existing data. and will complain if this is set to a different value' ],
);
set_verbosity(1) if $cli->{verbose};

exit main();

sub main {
	my $source = DnsSync::Provider::ZoneFile::get_records($cli->{directory});

	DnsSync::Provider::Route53::write_records($cli->{zone}, $source->{records}, {
		wait   => $cli->{wait},
		origin => $source->{origin} || $cli->{origin},
	});

	return 0;
}
